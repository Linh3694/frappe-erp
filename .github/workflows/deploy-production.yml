name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 42.96.40.246 >> ~/.ssh/known_hosts
          ssh-keyscan -H 172.16.20.111 >> ~/.ssh/known_hosts

      - name: Deploy to Production
        env:
          LB_HOST: ${{ secrets.LB_HOST || '42.96.40.246' }}
          BACKEND_HOST: ${{ secrets.BACKEND_HOST || '172.16.20.111' }}
          SSH_USER: ${{ secrets.SSH_USER || 'frappe' }}
          SITE_NAME: ${{ secrets.SITE_NAME || 'admin.erp.wellspring.edu.vn' }}
        run: |
          echo "ðŸš€ Starting deployment to production..."

          ssh -o StrictHostKeyChecking=no $SSH_USER@$LB_HOST << 'EOF'
          echo "ðŸ“¡ Connecting to backend server..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@172.16.20.111 << 'BACKEND_EOF'
            echo "ðŸ”„ Navigating to frappe-bench directory..."
            cd /srv/app/frappe-bench
            
            echo "ðŸ“‹ Current app status:"
            bench --version
            bench --site admin.erp.wellspring.edu.vn get-app-list || true
            
            echo "ðŸ”§ Backing up before update..."
            bench --site admin.erp.wellspring.edu.vn backup --with-files || true
            
            echo "â¸ï¸ Enabling maintenance mode..."
            bench --site admin.erp.wellspring.edu.vn set-maintenance-mode on
            
            echo "ðŸ“¥ Updating ERP app code..."
            cd apps/erp
            git stash push -m "Auto-stash before deployment $(date)" || true
            git fetch origin
            git reset --hard origin/main
            echo "âœ… App code updated to latest version"
            git log --oneline -3
            cd /srv/app/frappe-bench
            
            echo "ðŸ”„ Running database migration..."
            bench --site admin.erp.wellspring.edu.vn migrate
            
            echo "ðŸ—ï¸ Building assets..."
            bench build --app erp || true
            
            echo "ðŸ”„ Restarting services..."
            bench restart || true
            
            echo "â–¶ï¸ Disabling maintenance mode..."
            bench --site admin.erp.wellspring.edu.vn set-maintenance-mode off
            
            echo "âœ… Deployment completed successfully!"
            echo "ðŸ“Š Final status:"
            bench --site admin.erp.wellspring.edu.vn get-app-list
          BACKEND_EOF
          EOF

          echo "ðŸŽ‰ Production deployment completed!"

      - name: Notify on Success
        if: success()
        run: |
          echo "âœ… ERP App Ä‘Ã£ Ä‘Æ°á»£c deploy thÃ nh cÃ´ng lÃªn production!"
          echo "ðŸŒ Site: admin.erp.wellspring.edu.vn"
          echo "ðŸ“¦ Commit: ${{ github.sha }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment tháº¥t báº¡i!"
          echo "ðŸ” HÃ£y kiá»ƒm tra logs Ä‘á»ƒ tÃ¬m nguyÃªn nhÃ¢n."
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
