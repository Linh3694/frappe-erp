name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 42.96.40.246 >> ~/.ssh/known_hosts
          ssh-keyscan -H 172.16.20.111 >> ~/.ssh/known_hosts

      - name: Deploy to Production
        env:
          LB_HOST: ${{ secrets.LB_HOST || '42.96.40.246' }}
          BACKEND_HOST: ${{ secrets.BACKEND_HOST || '172.16.20.111' }}
          SSH_USER: ${{ secrets.SSH_USER || 'frappe' }}
          SITE_NAME: ${{ secrets.SITE_NAME || 'admin.sis.localhost' }}
        run: |
          echo "ðŸš€ Starting deployment to production..."

          # Táº¡o deployment script táº¡m thá»i
          cat > deploy_script.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ðŸ“¡ Connecting to backend server..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$BACKEND_HOST << 'BACKEND_EOF'
            echo "ðŸ”„ Navigating to frappe-bench directory..."
            cd /srv/app/frappe-bench
            
            echo "ðŸ“‹ Current status:"
            bench --version
            bench --site $SITE_NAME get-app-list
            
            echo "ðŸ”§ Backing up before update..."
            bench --site $SITE_NAME backup --with-files
            
            echo "â¸ï¸ Enabling maintenance mode..."
            bench --site $SITE_NAME set-maintenance-mode on
            
            echo "ðŸ“¥ Getting latest app version..."
            if [ -d "apps/erp" ]; then
              echo "ðŸ”„ Updating existing app..."
              cd apps/erp
              git fetch origin
              git reset --hard origin/main
              cd /srv/app/frappe-bench
            else
              echo "ðŸ“¦ Installing app for first time..."
              bench get-app erp https://github.com/Linh3694/frappe-erp.git
            fi
            
            echo "ðŸ”§ Installing/updating app on site..."
            if bench --site $SITE_NAME list-apps | grep -q "erp"; then
              echo "â™»ï¸ App already installed, migrating..."
              bench --site $SITE_NAME migrate
            else
              echo "ðŸ“¦ Installing app..."
              bench install-app erp --site $SITE_NAME
            fi
            
            echo "ðŸ—ï¸ Building assets..."
            bench build --app erp
            
            echo "ðŸ”„ Restarting services..."
            bench restart
            
            echo "â–¶ï¸ Disabling maintenance mode..."
            bench --site $SITE_NAME set-maintenance-mode off
            
            echo "âœ… Deployment completed successfully!"
            echo "ðŸ“Š Final status:"
            bench --site $SITE_NAME get-app-list
          BACKEND_EOF
          EOF

          chmod +x deploy_script.sh

          # Thá»±c thi deployment qua Load Balancer
          echo "ðŸŒ Connecting through Load Balancer to Backend..."
          scp -o StrictHostKeyChecking=no deploy_script.sh $SSH_USER@$LB_HOST:~/
          ssh -o StrictHostKeyChecking=no $SSH_USER@$LB_HOST "
            chmod +x ~/deploy_script.sh
            ~/deploy_script.sh
            rm ~/deploy_script.sh
          "

          echo "ðŸŽ‰ Production deployment completed!"

      - name: Notify on Success
        if: success()
        run: |
          echo "âœ… ERP App Ä‘Ã£ Ä‘Æ°á»£c deploy thÃ nh cÃ´ng lÃªn production!"
          echo "ðŸŒ Site: ${{ env.SITE_NAME }}"
          echo "ðŸ“¦ Commit: ${{ github.sha }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment tháº¥t báº¡i!"
          echo "ðŸ” HÃ£y kiá»ƒm tra logs Ä‘á»ƒ tÃ¬m nguyÃªn nhÃ¢n."
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f deploy_script.sh
