# Timetable Import Bugfix - 2025-11-14

## V·∫•n ƒë·ªÅ

Import th·ªùi kh√≥a bi·ªÉu v·ªõi NEW FORMAT (column-based) b·ªã fail v·ªõi th√¥ng b√°o:
- `‚ùå Validation failed: 0 errors, 0 warnings`
- `‚ùå Import failed during execution`
- Kh√¥ng c√≥ error message c·ª• th·ªÉ

## Nguy√™n nh√¢n

### 1. Validator kh√¥ng validate subjects cho NEW FORMAT
**File**: `import_validator.py`
**D√≤ng**: 244-245

```python
# OLD CODE - BUG
else:
    # NEW FORMAT: Class names are column headers
    df_columns = [str(col).strip() for col in self.df.columns]
    unique_classes = df_columns[2:]  # Skip "Th·ª©" and "Ti·∫øt"
    # Subjects will be validated during execution (from cell values)
    unique_subjects = []  # ‚ùå KH√îNG VALIDATE!
```

**H·∫≠u qu·∫£**:
- Validator pass v√¨ kh√¥ng check subjects
- Executor fail v√¨ kh√¥ng t√¨m th·∫•y subjects trong database
- Kh√¥ng c√≥ error message v√¨ validator ƒë√£ pass

### 2. Error logging kh√¥ng ƒë·ªß chi ti·∫øt
**File**: `import_executor.py`

```python
# OLD CODE - BUG
except Exception as e:
    frappe.db.rollback()
    frappe.log_error(f"Import execution failed: {str(e)}")
    
    return {
        "success": False,
        "message": "Import failed",  # ‚ùå KH√îNG CHI TI·∫æT
        "error": str(e),
        ...
    }
```

## Gi·∫£i ph√°p

### Fix 1: Validate subjects cho NEW FORMAT

```python
# NEW CODE - FIXED
else:
    # NEW FORMAT: Class names are column headers
    df_columns = [str(col).strip() for col in self.df.columns]
    unique_classes = df_columns[2:]  # Skip "Th·ª©" and "Ti·∫øt"
    
    # ‚úÖ Extract unique subjects from all class columns
    unique_subjects = set()
    for col in unique_classes:
        if col in self.df.columns:
            subjects = self.df[col].dropna().unique()
            for subj in subjects:
                subj_str = str(subj).strip()
                if subj_str and subj_str != "":
                    unique_subjects.add(subj_str)
    unique_subjects = list(unique_subjects)
```

### Fix 2: Enhanced error logging

```python
# NEW CODE - FIXED
except Exception as e:
    import traceback
    error_trace = traceback.format_exc()
    
    frappe.db.rollback()
    frappe.logger().error(f"üí• EXECUTOR CRASH: {str(e)}")
    frappe.logger().error(f"Traceback:\n{error_trace}")
    
    frappe.log_error(
        title="Timetable Import Executor Failed",
        message=f"Error: {str(e)}\n\nTraceback:\n{error_trace}"
    )
    
    return {
        "success": False,
        "message": f"Import failed: {str(e)}",  # ‚úÖ CHI TI·∫æT
        "error": str(e),
        "logs": self.logs + [
            f"‚ùå CRITICAL ERROR: {str(e)}",
            "Traceback:",
            *error_trace.split('\n')[-10:]
        ]
    }
```

### Fix 3: Step-by-step error handling

```python
# NEW CODE - FIXED
try:
    # Load Excel
    try:
        self._load_excel()
    except Exception as e:
        raise Exception(f"Failed to load Excel file: {str(e)}")
    
    # Build cache
    try:
        self._build_cache()
    except Exception as e:
        raise Exception(f"Failed to build cache: {str(e)}")
    
    # ... more steps with specific error messages
```

### Fix 4: Validate Subject Assignments cho NEW FORMAT

```python
# NEW CODE - FIXED in _check_subject_assignments()
if self.format == "row_based":
    # OLD FORMAT
    unique_pairs = self.df[["L·ªõp", "M√¥n h·ªçc"]].drop_duplicates()
    pairs_list = [(row["L·ªõp"], row["M√¥n h·ªçc"]) for _, row in unique_pairs.iterrows()]
else:
    # NEW FORMAT - ‚úÖ NOW VALIDATED
    class_columns = list(self.cache["classes"].keys())
    pairs_set = set()
    for class_title in class_columns:
        if class_title in self.df.columns:
            unique_subjects = self.df[class_title].dropna().unique()
            for subject_title in unique_subjects:
                subj_str = str(subject_title).strip()
                if subj_str and subj_str != "":
                    pairs_set.add((class_title, subj_str))
    pairs_list = list(pairs_set)
```

## Files Changed

1. **import_validator.py**
   - Line 231-283: `_validate_references()` - Extract and validate subjects from NEW FORMAT
   - Line 407-430: `_validate_business_rules()` - Enable Subject Assignment check for both formats
   - Line 475-540: `_check_subject_assignments()` - Support both formats

2. **import_executor.py**
   - Line 93-128: Enhanced error handling for each execution step
   - Line 128-152: Detailed error logging with traceback

## Testing

### Test Case 1: Missing Subject
**Excel**: Class "10A" has subject "To√°n" but "To√°n" kh√¥ng t·ªìn t·∫°i trong SIS Timetable Subject

**Expected**:
```
‚ùå Validation failed: 1 error
Error: Timetable Subject not found: 'To√°n'
```

### Test Case 2: Missing Subject Assignment
**Excel**: Class "10A" has subject "To√°n", subject exists, but no Subject Assignment

**Expected**:
```
‚ö†Ô∏è  Warning: No Subject Assignment found for class '10A' + subject 'To√°n'. 
Timetable will be created but teacher assignment may be incomplete.
```

### Test Case 3: Success
**Excel**: All subjects exist, all Subject Assignments exist

**Expected**:
```
‚úÖ Validation passed with 0 warnings
‚úÖ Import complete: 15 instances created, 450 rows created
```

## Debug Guide

Khi import fail, ki·ªÉm tra c√°c b∆∞·ªõc sau:

### 1. Check Frappe Error Log
`Desk > System > Error Log > Filter by "Timetable"`

S·∫Ω th·∫•y error v·ªõi:
- Title: "Timetable Import Validator Failed" ho·∫∑c "Timetable Import Executor Failed"
- Full Python traceback
- Exact error message

### 2. Check validation errors
Error message gi·ªù s·∫Ω r√µ r√†ng:
```
‚ùå Timetable Subject not found: 'M√¥n X'
‚ùå Class not found: 'L·ªõp Y'
‚ùå Period not found: 'Ti·∫øt Z'
```

### 3. Common Issues

#### Issue: "Timetable Subject not found"
**Solution**: Create subject in `SIS Timetable Subject` v·ªõi `title_vn` = t√™n trong Excel

#### Issue: "Subject mapping missing"
**Solution**: Create `SIS Subject` linking Timetable Subject to Actual Subject

#### Issue: "No Subject Assignment found"
**Solution**: Create `SIS Subject Assignment` for class + subject pair

#### Issue: "Class not found"
**Solution**: Check `short_title` or `title` of class matches Excel

#### Issue: "Period not found"
**Solution**: Check period names in Excel match `SIS Timetable Column.period_name`

## Rollback (if needed)

N·∫øu c·∫ßn rollback v·ªÅ code c≈©:
```bash
cd /Users/linh/frappe-bench-venv/apps/erp
git diff HEAD import_validator.py import_executor.py
git checkout HEAD -- import_validator.py import_executor.py
bench restart
```

## Performance Impact

- Validation time: +10-20ms (ƒë·ªÉ scan subjects trong NEW FORMAT)
- Execution time: No change
- Memory: No significant change

## References

- Original bug report: 2025-11-14 14:44
- Related files:
  - `import_validator.py`
  - `import_executor.py`
  - `import_excel.py`
- Format documentation: `README.md` in same directory

